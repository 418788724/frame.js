<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>frame.js editor</title>
	</head>
	<link id="theme" href="css/dark.css" rel="stylesheet" />
	<body>

		<script src="js/libs/signals.min.js"></script>
		<script src="js/libs/ui.js"></script>

        <script src="js/Editor.js"></script>
		<script src="js/Menubar.js"></script>
		<script src="js/Menubar.File.js"></script>
		<script src="js/Menubar.Edit.js"></script>
		<script src="js/Menubar.Add.js"></script>
		<script src="js/Menubar.Help.js"></script>
		<script src="js/Properties.js"></script>
		<script src="js/Viewport.js"></script>
		<script src="js/Timeline.js"></script>

		<script src="../build/frame.min.js"></script>
		<!-- <script src="../src/Frame.js"></script> -->

		<script src="js/modules/threejs/WebGLRendererModule.js"></script>
		<script src="js/modules/threejs/ClearModule.js"></script>
		<script src="js/modules/threejs/FadeInModule.js"></script>
		<script src="js/modules/threejs/ImageModule.js"></script>
		<script src="js/modules/threejs/ShaderModule.js"></script>

		<script src="../examples/template/js/libs/raf.min.js"></script>
		<script src="../examples/template/js/libs/three.min.js"></script>


		<script>

            var editor = new Editor();
            var signals = editor.signals;

			var properties = new Properties( editor ).setId( 'properties' );
			document.body.appendChild( properties.dom );

    		var viewport = new Viewport( editor ).setId( 'viewport' );
			document.body.appendChild( viewport.dom );

			var timeline = new Timeline( editor ).setId( 'timeline' );
			document.body.appendChild( timeline.dom );

			var menubar = new Menubar( editor ).setId( 'menubar' );
			document.body.appendChild( menubar.dom );

			//
            
			var json = {
				"metadata": {
					"version": 1
				},

				"timeline": [
					[ 0, 0, 70, "WebGLRendererModule" ],
					[ 1, 0, 70, "ClearModule" ],
					[ 2, 0, 14, "ShaderModule", { "url": "../examples/template/files/shaders/lights.fs", "speed": 10 } ],
					[ 3, 0, 14, "FadeInModule", { "color": "black" } ],
					[ 2, 14, 21, "ShaderModule", { "url": "../examples/template/files/shaders/cubeballs.fs", "speed": 6, "mouseX": 0.75, "mouseY": 0.75 } ],
					[ 2, 21, 28, "ShaderModule", { "url": "../examples/template/files/shaders/cubeballs.fs", "speed": 6, "mouseX": -0.75, "mouseY": 0.25 } ],
					[ 2, 28, 35, "ShaderModule", { "url": "../examples/template/files/shaders/planedistort.fs", "speed": 20 } ],
					[ 2, 35, 42, "ShaderModule", { "url": "../examples/template/files/shaders/planedistort.fs", "speed": 20, "offset": 450 } ],
					[ 3, 35, 37, "FadeInModule", { "color": "white" } ],
					[ 2, 42, 49, "ShaderModule", { "url": "../examples/template/files/shaders/field.fs", "speed": 20 } ],
					[ 3, 42, 44, "FadeInModule", { "color": "white" } ],
					[ 2, 49, 56, "ShaderModule", { "url": "../examples/template/files/shaders/field.fs", "speed": 20, "offset": 450 } ],
					[ 2, 56, 70, "ShaderModule", { "url": "../examples/template/files/shaders/blobs.fs", "speed": 10 } ],
					[ 3, 56, 70, "ImageModule", { "url": "../examples/template/files/credits.png" } ],
					[ 4, 56, 60, "FadeInModule", { "color": "white" } ]
				],

				"curves": [
				]
			};

            var modules = {};

			for ( var i = 0, l = json.timeline.length; i < l; i ++ ) {

				var data = json.timeline[ i ];

				var layer = data[ 0 ];
				var start = data[ 1 ];
				var duration = data[ 2 ];
				var moduleName = data[ 3 ];
				var parameters = data[ 4 ];

				if ( window[ moduleName ] === undefined ) {

					console.log( 'FRAME: Missing module: ' + moduleName );
					continue;

				}

                var module;

                if ( modules[ moduleName ] === undefined ) {

    				module = new window[ moduleName ];
                    module.name = moduleName;
                    
                    modules[ moduleName ] = module;
                    
                } else {
                    
                    module = modules[ moduleName ];
                    
                }

				for ( var key in parameters ) {

					if ( module.parameters.input[ key ] === undefined ) {

						console.log( 'FRAME: [' + moduleName + '] doesn\'t support "' + key + '" as input parameter' );
                        delete parameters[ key ];
						continue;

					}

				}
                
                if ( parameters.dom !== undefined ) {
                
                	parameters.dom = editor.dom;
                
                }
        
				var element = new FRAME.TimelineElement( moduleName, layer, start, duration, module, parameters );

                editor.add( element );

			}

			//

			var fullscreen = false;
			var time = 0, playing = false;

			var audio = document.createElement( 'audio' );
			audio.src = '../examples/template/files/lug00ber-bastion_amstel.ogg';
            document.body.appendChild( audio );

			signals.play.add( function () {

				if ( audio.paused === true ) {
					playing = true;
					audio.play();
					animate();
				} else {
					playing = false;
					audio.pause();
				}

			} );

			signals.backwards.add( function () {

				signals.setTime.dispatch( time - 1 );

			} );

			signals.forwards.add( function () {

				signals.setTime.dispatch( time + 1 );

			} );
            
            signals.decelerate.add( function () {

                audio.playbackRate -= 0.1;

			} );
            
            signals.accelerate.add( function () {

                audio.playbackRate += 0.1;

			} );

			signals.setTime.add( function ( value ) {

				time = Math.max( 0, value );
				signals.timeChanged.dispatch( time );
				if ( audio.duration > 0 ) audio.currentTime = value;
                
                location.hash = audio.currentTime;

			} );
            
            var hash = location.hash .substr( 1 );
            
            if ( hash !== '' ) {
                
                signals.setTime.dispatch( hash );
                
            }

			document.addEventListener( 'keydown', function ( event ) {

				switch ( event.keyCode ) {

					case 27: // 9:
                        
						if ( fullscreen === false ) {
                            // viewport.dom.webkitRequestFullScreen();
                            viewport.setLeft( '0px' );
                            viewport.setRight( '0px' );
                            viewport.setTop( '0px' );
                            viewport.setBottom( '0px' );
							fullscreen = true;
						} else {
                            // document.webkitCancelFullScreen();
                            viewport.setLeft( '300px' );
                            viewport.setRight( '0px' );
                            viewport.setTop( '32px' );
                            viewport.setBottom( '240px' );
							fullscreen = false;
						}
						break;
					case 32:
						signals.play.dispatch();
						break;
					case 37:
                        event.preventDefault();
						signals.setTime.dispatch( time - 1 );
						break;
					case 39:
                        event.preventDefault();
                        signals.setTime.dispatch( time + 1 );
						break;
					case 38:
                        event.preventDefault();
                        signals.accelerate.dispatch();
						break;
        			case 40:
                        event.preventDefault();
						signals.decelerate.dispatch();
						break;

				}

			} );

			var animate = function () {

				if ( playing === true ) {

					requestAnimationFrame( animate );

				}

				time = audio.currentTime;
				signals.timeChanged.dispatch( time );

			};

		</script>
	</body>
</html>
